// 1. Setup Persistent ID
    let myID = localStorage.getItem('bomber_uuid') || "ID_" + Math.floor(Math.random() * 999999);
    localStorage.setItem('bomber_uuid', myID);

    const pubnub = new PubNub({
        publishKey: "pub-c-e3f9234f-55b2-47f7-bfab-a6cf1a375472",
        subscribeKey: "sub-c-02383c88-1dca-4119-b262-196e9bedcea2",
        userId: myID
    });

    let currentRoom = "room_1";
    let activePlayers = {}; // Local list of players who have checked-in
    let gameActive = false;
    let countdownStarted = false;

    // 2. BROADCAST: Tell everyone you are here every 2 seconds
    setInterval(() => {
        if (!gameActive) {
            pubnub.publish({
                channel: currentRoom,
                message: { type: "HEARTBEAT", id: myID, name: document.getElementById('usernameInput').value || "Guest" }
            });
        }
    }, 2000);

    // 3. CLEANUP: If we haven't heard from someone in 5 seconds, remove them
    setInterval(() => {
        const now = Date.now();
        for (let id in activePlayers) {
            if (now - activePlayers[id].lastSeen > 5000) {
                delete activePlayers[id];
            }
        }
        updateUI();
    }, 1000);

    function updateUI() {
        const count = Object.keys(activePlayers).length;
        const btn = document.getElementById('startBtn');
        const status = document.getElementById('status-text');

        status.innerText = `Lobby: ${currentRoom.toUpperCase()} | Players: ${count}/6`;

        if (count >= 2 && !countdownStarted && !gameActive) {
            startCountDown();
        } else if (count < 2 && !countdownStarted) {
            btn.innerText = "WAITING FOR PLAYERS...";
            btn.disabled = true;
        }
    }

    pubnub.addListener({
        message: (m) => {
            const data = m.message;
            
            // Handle Heartbeats (Counting Players)
            if (data.type === "HEARTBEAT") {
                activePlayers[data.id] = { name: data.name, lastSeen: Date.now() };
            }

            // Handle Chat
            if (data.type === "chat") {
                const msgDiv = document.getElementById('chat-messages');
                msgDiv.innerHTML += `<div><b>${data.user}:</b> ${data.text}</div>`;
                msgDiv.scrollTop = msgDiv.scrollHeight;
            }

            // Handle Countdown Start
            if (data.type === "START_SYNC_COUNT") {
                triggerVisualCountdown();
            }
        }
    });

    function startCountDown() {
        if (countdownStarted) return;
        countdownStarted = true;
        pubnub.publish({ channel: currentRoom, message: { type: "START_SYNC_COUNT" } });
    }

    function triggerVisualCountdown() {
        let time = 10;
        const btn = document.getElementById('startBtn');
        const timer = setInterval(() => {
            btn.innerText = `STARTING IN ${time}...`;
            time--;
            if (time < 0) {
                clearInterval(timer);
                launch();
            }
        }, 1000);
    }

    function launch() {
        gameActive = true;
        document.getElementById('main-menu').classList.remove('visible');
        document.getElementById('game-screen').classList.add('visible');
    }

    // Subscribe to start receiving messages
    pubnub.subscribe({ channels: [currentRoom] });
