<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Word Bomber Lobby</title>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.2.min.js"></script>
    <style>
        :root { --bg-color: #121212; --text-color: #ffffff; --accent: #ff3c3c; --box-bg: rgba(255, 255, 255, 0.05); }
        body { font-family: 'Arial Black', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .master-wrapper { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 500px; text-align: center; }
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; }
        .visible { display: flex !important; }
        .btn { padding: 18px; font-size: 22px; color: white; background: var(--box-bg); border: 2px solid white; border-radius: 12px; cursor: pointer; width: 80%; margin: 10px 0; transition: 0.2s; }
        .btn:hover { background: white; color: black; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .menu-input { width: 80%; padding: 15px; font-size: 18px; margin-bottom: 10px; border-radius: 8px; border: 2px solid white; background: transparent; color: white; text-align: center; }
        #status-text { font-size: 16px; margin-top: 15px; color: var(--accent); }
        #chat-container { position: fixed; right: -300px; top: 0; width: 300px; height: 100%; background: #000; border-left: 1px solid #333; transition: 0.3s; z-index: 100; display: flex; flex-direction: column; }
        #chat-container.open { right: 0; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 10px; font-family: sans-serif; font-size: 13px; text-align: left; }
        #chat-input { padding: 15px; background: #111; border: none; color: white; outline: none; }
    </style>
</head>
<body>

    <div id="chat-container">
        <div style="padding: 10px; background: #222; cursor: pointer;" onclick="document.getElementById('chat-container').classList.toggle('open')">CLOSE CHAT</div>
        <div id="chat-messages"></div>
        <input type="text" id="chat-input" placeholder="Say something...">
    </div>

    <div class="master-wrapper">
        <div id="main-menu" class="screen visible">
            <h1 style="font-size: 50px; margin-bottom: 10px;">WORD BOMBER</h1>
            <input type="text" id="usernameInput" class="menu-input" placeholder="ENTER NAME..." maxlength="12">
            
            <button id="joinBtn" class="btn" onclick="connectToLobby()">JOIN LOBBY</button>
            
            <button id="startBtn" class="btn" style="display:none;" disabled>WAITING FOR PLAYERS...</button>
            
            <div id="status-text">Server Offline - Join to connect</div>
        </div>

        <div id="game-screen" class="screen">
            <h2 id="turn-display">GAME STARTING</h2>
            <div style="font-size: 100px;">ðŸ’£</div>
            <div id="prompt" style="font-size: 60px; border: 4px solid white; padding: 20px; border-radius: 15px; width: 150px;">?</div>
        </div>
    </div>

<script>
    let myID = localStorage.getItem('bomber_uuid') || "ID_" + Math.floor(Math.random() * 999999);
    localStorage.setItem('bomber_uuid', myID);

    let pubnub;
    let currentRoom = "room_1"; 
    let activePlayers = {};
    let gameActive = false;
    let countdownStarted = false;

    function connectToLobby() {
        const name = document.getElementById('usernameInput').value.trim();
        if (!name) return alert("Enter a name first!");

        pubnub = new PubNub({
            publishKey: "pub-c-e3f9234f-55b2-47f7-bfab-a6cf1a375472",
            subscribeKey: "sub-c-02383c88-1dca-4119-b262-196e9bedcea2",
            userId: myID
        });

        pubnub.addListener({
            message: (m) => {
                // Heartbeat Counting
                if (m.message.type === "PING") {
                    activePlayers[m.message.id] = { name: m.message.name, lastSeen: Date.now() };
                }
                // Chat
                if (m.message.type === "chat") {
                    const msgDiv = document.getElementById('chat-messages');
                    msgDiv.innerHTML += `<div><b>${m.message.user}:</b> ${m.message.text}</div>`;
                    msgDiv.scrollTop = msgDiv.scrollHeight;
                }
                // Global Sync Start
                if (m.message.type === "START_SYNC") {
                    beginCountdown();
                }
            }
        });

        pubnub.subscribe({ channels: [currentRoom] });

        // UI Changes
        document.getElementById('joinBtn').style.display = "none";
        document.getElementById('startBtn').style.display = "block";
        document.getElementById('status-text').innerText = "Connecting to Lobby...";

        // Start heartbeat "yelling"
        setInterval(() => {
            if (!gameActive && pubnub) {
                pubnub.publish({
                    channel: currentRoom,
                    message: { type: "PING", id: myID, name: document.getElementById('usernameInput').value }
                });
            }
        }, 2000);

        // Cleanup and count players
        setInterval(() => {
            const now = Date.now();
            for (let id in activePlayers) {
                if (now - activePlayers[id].lastSeen > 5000) delete activePlayers[id];
            }
            
            const count = Object.keys(activePlayers).length;
            document.getElementById('status-text').innerText = `Lobby: ROOM_1 | Players: ${count}/6`;

            // Auto-trigger countdown at 2 players
            if (count >= 2 && !countdownStarted) {
                countdownStarted = true;
                pubnub.publish({ channel: currentRoom, message: { type: "START_SYNC" } });
            }
        }, 1000);
    }

    function beginCountdown() {
        countdownStarted = true;
        let time = 10;
        const btn = document.getElementById('startBtn');
        const t = setInterval(() => {
            btn.innerText = `STARTING IN ${time}...`;
            time--;
            if (time < 0) {
                clearInterval(t);
                gameActive = true;
                document.getElementById('main-menu').classList.remove('visible');
                document.getElementById('game-screen').classList.add('visible');
            }
        }, 1000);
    }

    // Chat logic
    document.getElementById('chat-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && pubnub) {
            pubnub.publish({
                channel: currentRoom,
                message: { type: "chat", user: document.getElementById('usernameInput').value || "Guest", text: e.target.value }
            });
            e.target.value = "";
        }
    });
</script>
</body>
</html>
