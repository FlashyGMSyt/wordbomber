// Replace your existing window.onload section with this cleaner, safer version
window.onload = () => {
    const wordInput = document.getElementById('wordInput');
    const chatIn = document.getElementById('chat-in');

    // 1. GAME INPUT LOGIC
    if (wordInput) {
        wordInput.onkeydown = (e) => {
            if (e.key === 'Enter' && gameActive) {
                const val = e.target.value.toLowerCase().trim();
                if (val.includes(currentPrompt.toLowerCase()) && (words.size === 0 || words.has(val))) {
                    sfxCorrect.play();
                    score += val.length;
                    document.getElementById('score').innerText = score;
                    newRound();
                    timeLeft = 15.0;
                } else { 
                    e.target.value = ""; 
                }
            }
        };
    }

    // 2. CHAT INPUT LOGIC (Edge & Chrome Fix)
    if (chatIn) {
        chatIn.onkeydown = (e) => {
            if (e.key === 'Enter') {
                const msg = e.target.value.trim();
                if (!msg) return;

                if (typeof pubnub !== 'undefined' && pubnub) {
                    pubnub.publish({ 
                        channel: 'word-bomber-chat', 
                        message: { user: username || "Guest", text: msg } 
                    });
                } else {
                    // Show the local user their message even if offline/blocked
                    const d = document.getElementById('chat-msgs');
                    if (d) d.innerHTML += `<div><b style="color:gray;">(You):</b> ${msg} <i style="font-size:10px; color:red;">[Offline]</i></div>`;
                }
                
                e.target.value = ""; // ALWAYS clear the box so it doesn't get stuck
                const d = document.getElementById('chat-msgs');
                if (d) d.scrollTop = d.scrollHeight;
            }
        };
    }
    initGame();
};
