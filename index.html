const pubnub = new PubNub({
        publishKey: "pub-c-e3f9234f-55b2-47f7-bfab-a6cf1a375472",
        subscribeKey: "sub-c-02383c88-1dca-4119-b262-196e9bedcea2",
        userId: "ID_" + Math.floor(Math.random() * 9999)
    });

    let currentRoom = "room_1";
    let words = new Set(), syllables = [], gameActive = false, countdownStarted = false;
    let isMyTurn = false;

    // --- FIX: Refresh Occupancy Every 3 Seconds ---
    setInterval(() => {
        if(!gameActive) updateOccupancy();
    }, 3000);

    async function updateOccupancy() {
        try {
            const res = await pubnub.hereNow({ 
                channels: [currentRoom],
                includeUUIDs: true 
            });
            
            const count = res.totalOccupancy || 0;
            const btn = document.getElementById('startBtn');
            const status = document.getElementById('status-text');
            
            // Updates the red text at the bottom
            status.innerText = `Lobby: ${currentRoom.toUpperCase()} | Players: ${count}/6`;

            if (count >= 2 && !countdownStarted) {
                countdownStarted = true;
                pubnub.publish({
                    channel: currentRoom,
                    message: { type: "START_COUNTDOWN" }
                });
            }
        } catch (e) { console.error(e); }
    }

    async function joinBestRoom() {
        let roomNum = 1;
        while(true) {
            let roomName = "room_" + roomNum;
            const res = await pubnub.hereNow({ channels: [roomName] });
            if (res.totalOccupancy < 6) {
                currentRoom = roomName;
                pubnub.subscribe({ channels: [currentRoom], withPresence: true });
                // Small delay to let the join register
                setTimeout(updateOccupancy, 1000);
                break;
            }
            roomNum++;
        }
    }

    pubnub.addListener({
        presence: (p) => { updateOccupancy(); },
        message: (m) => {
            if (m.message.type === "chat") {
                const msgDiv = document.getElementById('chat-messages');
                msgDiv.innerHTML += `<div class="msg"><b>${m.message.user}:</b> ${m.message.text}</div>`;
                msgDiv.scrollTop = msgDiv.scrollHeight;
            }
            if (m.message.type === "START_COUNTDOWN") startTenSecondTimer();
            if (m.message.type === "GAME_LAUNCH") launchGame();
        }
    });

    function startTenSecondTimer() {
        countdownStarted = true;
        let timeLeft = 10;
        const btn = document.getElementById('startBtn');
        const timerObj = setInterval(() => {
            btn.disabled = true;
            btn.innerText = `STARTING IN ${timeLeft}...`;
            btn.style.background = "#ff3c3c";
            btn.style.color = "white";
            timeLeft--;
            if (timeLeft < 0) {
                clearInterval(timerObj);
                pubnub.publish({ channel: currentRoom, message: { type: "GAME_LAUNCH" } });
            }
        }, 1000);
    }

    // --- FIX: Grabs current name from input every time ---
    document.getElementById('chat-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target.value.trim() !== "") {
            let userVal = document.getElementById('usernameInput').value.trim() || "Guest";
            pubnub.publish({ 
                channel: currentRoom, 
                message: { type: "chat", user: userVal, text: e.target.value } 
            });
            e.target.value = "";
        }
    });

    function launchGame() {
        document.getElementById('main-menu').classList.remove('visible');
        document.getElementById('game-screen').classList.add('visible');
        startSequence(); 
    }

    // ... (Keep your existing startSequence, Promise.all, and word list loading code below this) ...
